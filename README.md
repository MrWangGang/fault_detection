# ⚙️ 深度迁移学习驱动的工业振动故障诊断：STFT-CNN 与 LoRA 高效微调

## 简介 (Introduction)

本项目专注于旋转机械的智能故障诊断，通过将原始振动信号转换为**时频图（STFT 谱图）**，并利用 **ResNet** 等深度学习模型进行分类。项目的核心亮点在于其支持**多源数据处理（CWRU `.mat` 和工业级 `.tdms`）**，以及在目标领域（Target Domain）引入 **LoRA (Low-Rank Adaptation)** 参数高效微调技术，以解决迁移学习或领域自适应中的数据稀疏问题。

## 📁 文件结构与功能

本项目包含数据预处理、可视化报告工具和多域模型训练脚本：

| 文件夹/文件 | 描述 | 关键功能点 | 关键技术/数据类型 |
| :--- | :--- | :--- | :--- |
| **datasets/** | 存放原始信号数据，结构应按类别划分。 | N/A | `.mat` (CWRU), `.tdms` (Origin/Target) |
| **data/** | 存放预处理后生成的 224x224 STFT 图像。 | N/A | `.png` 图像文件 |
| `convert_cwru.py` | CWRU 数据集（.mat 文件）预处理脚本。 | 读取 `.mat` 文件，提取信号通道，生成 STFT 图像。 | CWRU, MAT 文件 |
| `convert_origin.py` | 原始域数据（.tdms 文件）预处理脚本。 | 固定读取 `数据/RZ` 通道，生成 STFT 图像。 | Origin Domain, TDMS 文件 |
| `convert_target.py` | 目标域数据（.tdms 文件）预处理脚本。 | 固定读取 `数据/RZ` 通道，生成 STFT 图像。 | Target Domain, TDMS 文件 |
| `pre_*.py` | 三个域的数据可视化报告脚本。 | 针对每个类别，生成包含波形图和 STFT 谱图的 PDF 报告，用于数据质量检查。 | 信号可视化, PDF 报告 |
| `Reporter.py` | 核心报告和可解释性工具模块。 | 绘制训练历史、混淆矩阵、t-SNE 降维、Grad-CAM 和 LIME 可解释性分析。 | 模型可解释性 |
| `train_cwru.py` | CWRU 数据集全量训练脚本。 | 使用 ResNet (如 `resnet50`) 模型进行多分类训练 (10 类别)。 | ResNet, 10 Classes |
| `train_origin.py` | 原始域数据集全量训练脚本。 | 使用 ResNet (如 `resnet50`) 模型进行多分类训练 (5 类别)。 | ResNet, 5 Classes |
| `train_target.py` | **目标域 LoRA 微调脚本**。 | 引入 `LoRA_Wrapper` 进行高效微调，支持迁移学习。 | ResNet-LoRA, PEFT |

## ✨ 核心技术亮点

### 1. 统一的时频图转换 (STFT)

所有原始信号数据均被统一转换为标准的 224x224 像素 STFT 谱图，作为 CNN 模型的输入。

| 参数 | 值 | 说明 |
| :--- | :--- | :--- |
| 窗口长度 (`WINDOW_LENGTH`) | `1024` | FFT 窗口的大小（时域切片长度） |
| 步长 (`STEP_SIZE`) | `256` | 窗口的滑动步长（重叠度高） |
| NFFT 大小 (`NFFT_SIZE`) | `128` | 决定了 STFT 谱图的频率分辨率 |
| 目标图像尺寸 | `224x224` | 标准化图像尺寸，适配主流预训练模型 |

### 2. LoRA 参数高效微调 (PEFT)

`train_target.py` 集成了 LoRA 技术，专为目标域微调设计：

* **LoRA 封装 (`LoRA_Wrapper`)**：通过 `register_buffer` 机制，确保原始权重 $W_0$ 被冻结，不计入可训练参数。
* **低秩分解**：仅训练低秩分解矩阵 $A$ 和 $B$ (`self.lora_A`, `self.lora_B`)，大幅减少了微调所需的参数量和计算资源。
* **适用性**：支持对 `nn.Linear` 和 `nn.Conv2d` (1x1) 模块进行 LoRA 注入。

### 3. 全面的模型报告与可解释性

`Reporter.py` 模块提供了强大的模型分析功能：

* **特征可视化**：支持 **t-SNE** 降维可视化，用于观察模型提取的特征在二维空间中的聚类效果。
* **可解释性分析**：集成 **Grad-CAM** 和 **LIME**，能够定位模型在 STFT 图像中关注的关键区域，增强诊断结果的可信度。

## 4. 迁移学习策略与实施 (Transfer Learning Strategy)

本项目采用标准的**基于预训练的迁移学习**范式，利用源领域（CWRU 或 Origin）的丰富数据训练一个强大的特征提取器，随后将其高效迁移到数据量有限的目标领域（Target Domain）进行微调和适应。

### 4.1. 预训练阶段 (Pre-training Phase)

**目标：** 在数据分布不同但规模充足的源域上，学习振动信号的时频特征表示。
**实现脚本：**
* **CWRU 预训练 (`train_cwru.py`)：** 在 CWRU 数据集（10 类别）上进行全量训练。模型学习基本的轴承故障特征。
* **Origin 预训练 (`train_origin.py`)：** 在 Origin 数据集（5 类别）上进行全量训练。模型学习更贴近实际工业传感器的振动模式。

**迁移权重：** 预训练完成后，保存的最佳模型权重将作为目标域任务的起始权重。

### 4.2. 目标域适应阶段 (Target Domain Adaptation Phase)

**目标：** 将预训练模型的通用知识快速、高效地适应到目标域的特定工况和故障类别上。
**实现脚本：** `train_target.py` 脚本，它支持以下**三种**迁移模式，以应对不同规模和域差异的目标数据集：

#### 模式 A：LoRA 参数高效微调 (PEFT) - 推荐
* **策略：** 冻结 ResNet 主体权重，仅通过训练低秩矩阵 ($A$ 和 $B$) 将适配层权重增量 $\Delta W$ 添加到冻结的 $W_0$ 上。
* **训练参数：** 极少（仅 $A, B$ 和分类头）。
* **适用场景：** 目标域数据量极少或需要快速验证，能最大限度避免过拟合。

#### 模式 B：全冻结微调 (Feature Extractor)
* **策略：** **完全冻结** ResNet 主干网络（所有卷积层和 Batch Normalization 层），只训练最终的分类头（全连接层）。
* **训练参数：** 极少（仅分类头）。
* **适用场景：** 目标域数据量极少，且目标域和源域的数据分布差异非常小。

#### 模式 C：半冻结微调 (Partial Fine-tuning)
* **策略：** 冻结模型早期的浅层特征提取层（如 ResNet 的 `layer1`），解冻并训练模型后期的深层特征层（如 `layer3`、`layer4`）和分类头。
* **训练参数：** 中等（模型深层和分类头）。
* **适用场景：** 目标域与源域数据有一定差异，且目标域数据量适中，需要中等到深层的特征适应。
